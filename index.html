<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì„œìš¸ì‹œ ìŠ¤ì¼€ì´íŠ¸ë³´ë“œ íŒŒí¬ ì§€ë„ (Final)</title>
    
    <style>
        /* 1. ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
        html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; font-family: 'Malgun Gothic', sans-serif;}
        .container { position: relative; width: 100%; height: 100%; }
        #map { width: 100%; height: 100%; }

        /* 2. ì‚¬ì´ë“œë°” (ë¦¬ìŠ¤íŠ¸) */
        .sidebar { position: absolute; top: 15px; left: 15px; bottom: 15px; width: 360px; background: rgba(255, 255, 255, 0.95); z-index: 20; box-shadow: 0 5px 15px rgba(0,0,0,0.15); border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; }
        .search-box { padding: 15px; border-bottom: 1px solid #eee; }
        .search-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; outline: none; }
        .park-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; }
        .park-item { padding: 18px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .park-item:hover { background: #f1f8ff; }
        .item-title { font-weight: bold; font-size: 15px; display: block; color: #222; margin-bottom: 5px;}
        .item-desc { font-size: 13px; color: #777; line-height: 1.4; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: white; font-weight: bold; margin-left: 5px; vertical-align: middle;}
        .hard { background-color: #ff4757; } .medium { background-color: #ffa502; } .easy { background-color: #2ed573; }
          /*  ëª¨ë°”ì¼ ì „ìš© í•¸ë“¤ (ë°ìŠ¤í¬íƒ‘ì—ì„  ìˆ¨ê¹€) */
        .mobile-handle-area { display: none; width: 100%; padding: 10px 0; background: #fff; cursor: pointer; justify-content: center; align-items: center; border-bottom: 1px solid #f5f5f5; }
        .mobile-handle-bar { width: 40px; height: 5px; background: #e0e0e0; border-radius: 10px; }

        .search-box { padding: 15px; border-bottom: 1px solid #eee; background: #fff; }
        .search-input { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 14px; outline: none; }
        .park-list { flex: 1; overflow-y: auto; list-style: none; padding: 0; margin: 0; background: #fff; }
        .park-item { padding: 18px 15px; border-bottom: 1px solid #f0f0f0; cursor: pointer; transition: background 0.2s; }
        .park-item:hover { background: #f1f8ff; }
        .item-title { font-weight: bold; font-size: 15px; display: block; color: #222; margin-bottom: 5px;}
        .item-desc { font-size: 13px; color: #777; line-height: 1.4; }
        .badge { padding: 2px 6px; border-radius: 4px; font-size: 11px; color: white; font-weight: bold; margin-left: 5px; vertical-align: middle;}
        .hard { background-color: #ff4757; } .medium { background-color: #ffa502; } .easy { background-color: #2ed573; }
        .dist-badge { background-color: #535c68; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; font-weight: normal; }

        /* ê±°ë¦¬ í‘œì‹œìš© ë°°ì§€ */
        .dist-badge { background-color: #535c68; color: #fff; padding: 2px 6px; border-radius: 4px; font-size: 11px; margin-left: 5px; font-weight: normal; }

        /* 3. ì •ë³´ì°½ (ì»¤ìŠ¤í…€ ìŠ¤íƒ€ì¼) */
        .wrap { width: 280px; background: #fff; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); overflow: hidden; }
        .info-header { padding: 12px; background: #f8f9fa; border-bottom: 1px solid #eee; font-weight: bold; font-size: 15px; display: flex; justify-content: space-between; align-items: center;}
        
        /* ì´ë¯¸ì§€ ìŠ¬ë¼ì´ë“œ ì˜ì—­ */
        .info-img-box { position: relative; width: 100%; height: 160px; background: #eee; overflow: hidden; }
        .info-img { width: 100%; height: 100%; object-fit: cover; }
        
        /* ìŠ¬ë¼ì´ë“œ í™”ì‚´í‘œ */
        .slide-nav { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.5); color: white; border: none; cursor: pointer; padding: 8px 12px; font-size: 14px; z-index: 10; border-radius: 4px; }
        .nav-prev { left: 0; }
        .nav-next { right: 0; }
        .slide-nav:hover { background: rgba(0,0,0,0.8); }

        /* í…ìŠ¤íŠ¸ ì˜ì—­ */
        .text-slide { padding: 10px 15px; font-size: 13px; line-height: 1.6; }
        .info-row { margin-bottom: 5px; }
        
        /* ë””ë””ë¯¸ íŒŒí¬ìš© ë¶„ì„ ë°•ìŠ¤ */
        .analysis-box { background: #f1f8ff; padding: 10px; margin-top: 5px; border-radius: 6px; border-left: 4px solid #6c5ce7; }
        .analysis-title { font-weight: bold; display: block; margin-bottom: 4px; color: #333; }
        .analysis-data { font-size: 12px; color: #555; display: block; }
        .diff-tag { display: inline-block; padding: 2px 6px; border-radius: 4px; color: #fff; font-size: 11px; margin-left: 5px; vertical-align: middle; }
        .diff-easy { background: #2ed573; } .diff-medium { background: #ffa502; } .diff-hard { background: #ff4757; }

        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; gap: 5px; margin-top: 10px; }
        .btn-common { flex: 1; padding: 10px 0; border-radius: 6px; font-size: 12px; font-weight: bold; border: none; cursor: pointer; text-decoration: none; text-align: center; display: inline-block;}
        .btn-find { background-color: #FEE500; color: #000; }
        .btn-3d { background: linear-gradient(135deg, #6c5ce7, #a29bfe); color: white; }

        /* 4. 3D ì‹œë„¤ë§ˆ ëª¨ë‹¬ */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.95); z-index: 9999; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .modal-overlay.show { display: flex; }
        .modal-content { width: 100%; height: 100%; position: relative; }
        .close-btn { position: absolute; top: 20px; right: 20px; z-index: 100; color: white; font-size: 30px; cursor: pointer; background: rgba(0,0,0,0.5); width: 40px; height: 40px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); display: flex; align-items: center; justify-content: center; }
        iframe#lumaFrame { width: 100%; height: 100%; border: none; background: #000; }
        .section-buttons { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 8px; z-index: 100; background: rgba(0,0,0,0.6); padding: 8px; border-radius: 30px; flex-wrap: wrap; justify-content: center; width: 90%; max-width: 600px; }
        .sec-btn { padding: 8px 16px; background: rgba(255,255,255,0.1); color: white; border: 1px solid rgba(255,255,255,0.3); border-radius: 20px; cursor: pointer; font-size: 13px; }
        .sec-btn.active { background: #6c5ce7; border-color: #6c5ce7; font-weight: bold; box-shadow: 0 0 10px #6c5ce7; }

        @media screen and (max-width: 768px) {
            .container { flex-direction: column; }
            .sidebar { position:static; width: 100%; height: 40%; border-radius: 0; }
            #map { height: 60%; }
            .section-buttons { bottom: 15px; width: 95%; }
        }
    </style>
</head>
<body>

    <div class="container">
        <div id="map"></div>
        <div class="sidebar">
            <div class="search-box"><input type="text" id="searchInput" class="search-input" placeholder="ì§€ì—­ëª… ê²€ìƒ‰ (ì˜ˆ: ê°•ë‚¨ì—­, í™ëŒ€)"></div>
            <ul class="park-list" id="parkList"></ul>
        </div>
    </div>

    <div id="lumaModal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">âœ•</button>
            <iframe id="lumaFrame" src="" allow="accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture"></iframe>
            <div id="sectionBtnContainer" class="section-buttons"></div>
        </div>
    </div>

    <script type="text/javascript" src="https://dapi.kakao.com/v2/maps/sdk.js?appkey=9dca9728dc03540c74a0fdd9c0e84c56&libraries=services"></script>

    <script>
        var mapContainer = document.getElementById('map'), 
            mapOption = { center: new kakao.maps.LatLng(37.5986261, 127.0922478), level: 8 }; 
        var map = new kakao.maps.Map(mapContainer, mapOption); 
        
        // ğŸš€ ì¥ì†Œ ê²€ìƒ‰ ì„œë¹„ìŠ¤ ì¶”ê°€
        var ps = new kakao.maps.services.Places();

        var imageSize = new kakao.maps.Size(30, 30); 
        var imageOption = {offset: new kakao.maps.Point(17, 35)}; 
        var redMarkerImg = new kakao.maps.MarkerImage("./park.png", imageSize, imageOption);
        var blueMarkerImg = new kakao.maps.MarkerImage("./street.png", imageSize, imageOption);

        // ğŸ”´ ë°ì´í„° ì •ì˜
        var skateParks = [
            { 
                title: "ë””ë””ë¯¸ ìŠ¤ì¼€ì´íŠ¸íŒŒí¬", type: "street", addr: "ë™ëŒ€ë¬¸êµ¬ ë‹µì‹­ë¦¬", 
                lat: 37.5784979, lng: 127.0347585, level: "ë³µí•©", levelClass: "medium", hours: "09:00-23:00", 
                slides: [
                    { img: "./ledge.jpg", title: "â‘  ë©”ì¸ ë ›ì§€", diff: "ì¤‘ê¸‰", diffClass: "diff-medium", desc: "ë†’ì´: 37.6cm", detail: "ì˜¬ë¼íƒ€ë ¤ë©´ ì•Œë¦¬ í•„ìˆ˜ì , ê²½ì‚¬ë¡œì— ì°©ì§€ ì‹œ ë¶€ì¥ ì£¼ì˜" },
                    { img: "./quarterpipe.jpg", title: "â‘¡ ì¿¼í„° íŒŒì´í”„", diff: "ìƒê¸‰", diffClass: "diff-hard", desc: "ì§„ì…ê°ë„: 56.5ë„ / ë†’ì´: 166cm", detail: "ì§„ì… ê°ë„ê°€ ê°€íŒŒë¦„. ì´ˆë³´ì ë“œëì¸ ì—°ìŠµ ì‹œ ë¶€ìƒ ì£¼ì˜." },
                    { img: "./stair.jpg", title: "â‘¢ 4ê³„ë‹¨", diff: "ì¤‘ê¸‰", diffClass: "diff-easy", desc: "ë†’ì´: 41cm / ê¸¸ì´: 174cm" , detail: "ì¼ë°˜ ê³„ë‹¨ì— ë¹„í•´ ë†’ì´ ë‚®ìŒ, ê·¸ëŸ¬ë‚˜ ê³„ë‹¨ ê¸¸ì´ê°€ ê¸º, ë¹ ë¥¸ ì†ë„ í•„ìš”" }
                ],
                lumaSections: [
                    { name: "â‘  Street section", url: "https://lumalabs.ai/capture/323cd2c1-7df9-4095-bd49-86d8c5496773" },
                    { name: "â‘¡ Quarter Pipe", url: "https://lumalabs.ai/capture/556d0432-15a6-4f21-8526-93125a5e27cf" },
                    { name: "â‘¢ Transition Section", url: "https://lumalabs.ai/capture/2bba5927-5787-4284-bd77-59378a237347" },
                    { name: "â‘£ Stair set", url: "https://lumalabs.ai/capture/c78a526c-66a3-4ecb-bea1-6f84c65ca3b6" } 
                ],
                images: ["./dedimi1.jpg"] 
            },
            { title: "ë§ìš°ì—­ ê´‘ì¥", type: "park", addr: "ì¤‘ë‘êµ¬ ë§ìš°ë™", lat: 37.5986261, lng: 127.0922478, level: "ì¤‘ê¸‰", levelClass: "medium", hours: "24ì‹œê°„", desc: "ì—­ ì• ëŒ€ë¦¬ì„ ê´‘ì¥.", images: ["./mangu1.jpg"] },
            { title: "í›ˆë ¨ì› ê³µì›", type: "park", addr: "ì¤‘êµ¬ ì„ì§€ë¡œ", lat: 37.567475, lng: 127.004690, level: "ìƒê¸‰", levelClass: "hard", hours: "08-20ì‹œ", desc: "ìŠ¤íŠ¸ë¦¿ ì„±ì§€, ëŒ€ë¦¬ì„ íƒ€ì¼ ë°”ë‹¥", images: ["./culti1.jpg"] },
            { title: "ì‚´ê³¶ì´ ìŠ¤ì¼€ì´íŠ¸íŒŒí¬", type: "park", addr: "ì„±ë™êµ¬ ì‚¬ê·¼ë™", lat: 37.55388942037683, lng: 127.04620689153671, level: "ì´ˆ/ì¤‘ê¸‰", levelClass: "easy", hours: "08-23ì‹œ", desc: "23ì‹œ ì†Œë“±, í‰ì§€ ê³µê°„ í˜‘ì†Œ.", images: ["./salgoji1.jpg"] },
            { title: "ì„œìš¸ìˆ² ìŠ¤ì¼€ì´íŠ¸íŒŒí¬", type: "park", addr: "ì„±ë™êµ¬ ì„±ìˆ˜ë™", lat: 37.5449601201967, lng: 127.04219698905945, level: "ì´ˆ/ì¤‘ê¸‰", levelClass: "easy", hours: "08-22ì‹œ", desc: "ìˆ²ì† ê°ì„±. ë°”ë‹¥ ì•ˆ ì¢‹ìŒ", images: ["./seoulforest1.jpg"] },
            { title: "í•œê°• ì´ì´Œ ìŠ¤ì¼€ì´íŠ¸íŒŒí¬ ", type: "park", addr: "ìš©ì‚°êµ¬ ì´ì´Œë™", lat: 37.5193588, lng: 126.9661931, level: "ì´ˆê¸‰", levelClass: "easy", hours: "24ì‹œê°„", desc: "ë‹¤ë¦¬ ë°‘ ê·¸ëŠ˜. ë°”ë‹¥ ë¶€ë“œëŸ¬ì›€.", images: ["./ichon1.jpg"] },
            { title: "ê´‘ë‚˜ë£¨ ìŠ¤ì¼€ì´íŠ¸íŒŒí¬", type: "park", addr: "ê°•ë™êµ¬ ì•”ì‚¬ë™", lat: 37.5395428, lng: 127.114726, level: "ì¤‘ê¸‰", levelClass: "medium", hours: "24ì‹œê°„", desc: "ë…¸ë€ ê¸°ë¬¼, ë°”ë‹¥ ë§¤ìš° ë§¤ë„ëŸ¬ì›€.", images: ["./gwangnaru1.jpg"] },
            { title: "ë…¸ì› X-TOP", type: "park", addr: "ë…¸ì›êµ¬ ìƒê³„ë™", lat: 37.648430, lng: 127.07047, level: "ìƒê¸‰", levelClass: "hard", hours: "09-22ì‹œ", desc: "ì˜¬ë¦¼í”½ ê·œê²©. ë³´ìš¸(Bowl) ë³´ìœ .", images: ["./nohae1.jpg"] },
            { title: "ëšì„¬ í•œê°•ê³µì›", type: "park", addr: "ê´‘ì§„êµ¬ ìì–‘ë™", lat: 37.52968, lng: 127.071769, level: "ìƒê¸‰", levelClass: "hard", hours: "24ì‹œê°„", desc: "ì„œìš¸ ìµœëŒ€ ê·œëª¨ íŒŒí¬", images: ["./ttukseom1.jpg"] },
            { title: "ë‚œì§€ ìµìŠ¤íŠ¸ë¦¼ì¥", type: "park", addr: "ë§ˆí¬êµ¬ ìƒì•”ë™", lat: 37.568461, lng: 126.874672, level: "ì¤‘ê¸‰", levelClass: "medium", hours: "09-18ì‹œ", desc: "í•˜í”„íŒŒì´í”„ ë³´ìœ .", images: ["./nanji1.jpg"] },
            { title: "ë³´ë¼ë§¤ X-GAMEì¥", type: "park", addr: "ë™ì‘êµ¬ ì‹ ëŒ€ë°©ë™", lat:  37.49085534924308, lng:126.9218516349792, level: "ì´ˆê¸‰", levelClass: "easy", hours: "06-22ì‹œ", desc: "ëŒ€íšŒ ì½”ìŠ¤ êµ¬ì„±, í—¬ë©§ í•„ìˆ˜.", images: ["./boramae1.png"] },
            { title: "ìµìŠ¤íŠ¸ë¦¼ ì€í‰", type: "park", addr: "ì€í‰êµ¬ ì§„ê´€ë™", lat: 37.638671, lng: 126.9172385, level: "ì¤‘ê¸‰", levelClass: "medium", hours: "12:00-19:00", desc: "ì€í‰êµ¬ ìµœì´ˆ ì „ìš© íŒŒí¬.", images: ["./eunpyeong1.jpg"] }
        ];

        var markers = [];
        var infowindows = [];
        var currentSlideIndices = {}; 

        renderList(skateParks);
        createMarkers(skateParks);

        // ğŸŸ¢ ê²€ìƒ‰ ê¸°ëŠ¥
        var searchInput = document.getElementById('searchInput');
        searchInput.addEventListener('keyup', function(e) {
            if(e.key === 'Enter') { 
                var keyword = this.value.trim();
                if(!keyword) return;

                var filtered = skateParks.filter(function(item) {
                    return item.title.includes(keyword) || item.addr.includes(keyword);
                });

                if(filtered.length > 0) {
                    renderList(filtered); 
                } else {
                    ps.keywordSearch(keyword, placesSearchCB);
                }
            }
        });

        // ğŸŸ¢ ì¥ì†Œ ê²€ìƒ‰ ì½œë°±
        function placesSearchCB(data, status, pagination) {
            if (status === kakao.maps.services.Status.OK) {
                var target = data[0]; 
                var center = new kakao.maps.LatLng(target.y, target.x);
                map.setCenter(center); 

                // ê²€ìƒ‰ëœ ìœ„ì¹˜ í™•ëŒ€
                map.setLevel(4, {animate: true});

                var sortedParks = skateParks.map(function(park) {
                    var dist = getDistanceFromLatLonInKm(target.y, target.x, park.lat, park.lng);
                    park.distance = dist.toFixed(1); 
                    return park;
                }).sort(function(a, b) {
                    return a.distance - b.distance;
                });

                renderList(sortedParks);
                alert(`'${target.place_name}' ì£¼ë³€ íŒŒí¬ë¥¼ ê±°ë¦¬ìˆœìœ¼ë¡œ í‘œì‹œí•©ë‹ˆë‹¤.`);

            } else {
                alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©°, ê·¼ì²˜ íŒŒí¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
        }

        // ê±°ë¦¬ ê³„ì‚° í•¨ìˆ˜
        function getDistanceFromLatLonInKm(lat1,lon1,lat2,lon2) {
            var R = 6371; 
            var dLat = deg2rad(lat2-lat1);  
            var dLon = deg2rad(lon2-lon1); 
            var a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                    Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * Math.sin(dLon/2) * Math.sin(dLon/2); 
            var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
            var d = R * c; 
            return d;
        }
        function deg2rad(deg) { return deg * (Math.PI/180); }

        function renderList(data) {
            var listEl = document.getElementById('parkList');
            listEl.innerHTML = ''; 
            data.forEach(function(item) {
                var li = document.createElement('li');
                li.className = 'park-item';
                var badge3D = (item.lumaSections) ? '<span style="color:#6c5ce7; font-weight:bold;"> [ğŸ§Š3D]</span>' : '';
                var distBadge = (item.distance) ? `<span class="dist-badge">ğŸ“ ${item.distance}km</span>` : '';

                li.innerHTML = `<span class="item-title">${item.title} <span class="badge ${item.levelClass}">${item.level}</span>${distBadge}${badge3D}</span><span class="item-desc">${item.addr}</span>`;
                
                li.onclick = function() { 
                    var moveLatLon = new kakao.maps.LatLng(item.lat, item.lng);
                    map.setLevel(3, {animate: true}); // ë¦¬ìŠ¤íŠ¸ í´ë¦­ ì‹œì—ë„ í™•ëŒ€
                    map.panTo(moveLatLon);
                };
                listEl.appendChild(li);
            });
        }

        function createMarkers(data) {
            data.forEach(function(item, index) {
                currentSlideIndices[index] = 0;
                var currentImage = (item.type === 'street') ? blueMarkerImg : redMarkerImg;
                var marker = new kakao.maps.Marker({
                    map: map, position: new kakao.maps.LatLng(item.lat, item.lng), image: currentImage
                });
                
                var content = generateInfoWindowContent(item, index);
                var infowindow = new kakao.maps.InfoWindow({ content: content, removable: true });
                infowindows.push(infowindow);

                // ğŸŸ¢ [ì¶”ê°€ëœ ê¸°ëŠ¥] ë§ˆì»¤ í´ë¦­ ì´ë²¤íŠ¸
                kakao.maps.event.addListener(marker, 'click', function() {
                    // 1. ê¸°ì¡´ ì°½ ë‹«ê¸°
                    infowindows.forEach(iw => iw.close());
                    // 2. í˜„ì¬ ì°½ ì—´ê¸°
                    infowindow.open(map, marker);
                    // 3. âœ¨ í™•ëŒ€ ë° ì´ë™ (ë ˆë²¨ 3 = ìƒì„¸ í™•ëŒ€)
                    map.setLevel(3, {animate: true});
                    map.panTo(marker.getPosition());
                });
            });
        }

        function generateInfoWindowContent(item, index) {
            var imgHtml = '';
            var textHtml = '';
            var hasMultiImg = (item.images && item.images.length > 1);

            if (item.slides && item.slides.length > 0) {
                var s = item.slides[0];
                imgHtml = `
                    <div class="info-img-box">
                        <img id="slideImg_${index}" src="${s.img}" class="info-img" onerror="this.src='https://via.placeholder.com/300x150?text=No+Image'">
                        <button class="slide-nav nav-prev" onclick="changeSlide(${index}, -1)">â®</button>
                        <button class="slide-nav nav-next" onclick="changeSlide(${index}, 1)">â¯</button>
                    </div>`;
                textHtml = `
                    <div class="analysis-box">
                        <span id="slideTitle_${index}" class="analysis-title">${s.title} <span class="diff-tag ${s.diffClass}">${s.diff}</span></span>
                        <span id="slideDesc_${index}" class="analysis-data">ğŸ“ ${s.desc}</span>
                        <span id="slideDetail_${index}" class="analysis-data">ğŸ“ ${s.detail}</span>
                    </div>`;
            } else {
                var firstImg = (item.images && item.images.length > 0) ? item.images[0] : 'https://via.placeholder.com/300x150?text=No+Image';
                if (hasMultiImg) {
                    imgHtml = `
                        <div class="info-img-box">
                            <img id="slideImg_${index}" src="${firstImg}" class="info-img">
                            <button class="slide-nav nav-prev" onclick="changeSlide(${index}, -1)">â®</button>
                            <button class="slide-nav nav-next" onclick="changeSlide(${index}, 1)">â¯</button>
                        </div>`;
                } else {
                    imgHtml = `<div class="info-img-box"><img src="${firstImg}" class="info-img"></div>`;
                }
                textHtml = `<div class="text-slide"><div class="info-row">${item.desc}</div></div>`;
            }

            var btnHtml = `<div class="btn-group" style="margin-top:10px;">
                <a href="https://map.kakao.com/link/to/${item.title},${item.lat},${item.lng}" target="_blank" class="btn-common btn-find">ğŸš€ ê¸¸ì°¾ê¸°</a>`;
            if(item.lumaSections) {
                btnHtml += `<button class="btn-common btn-3d" onclick="openLumaModal(${index})">ğŸ§Š 3D ì‹œë„¤ë§ˆ</button>`;
            }
            btnHtml += `</div>`;

            return `<div class="wrap" style="width:300px;">
                        <div class="info-header">${item.title}</div>
                        ${imgHtml}
                        <div style="padding:0 10px 10px 10px;">
                            ${textHtml}
                            ${btnHtml}
                        </div>
                    </div>`;
        }

        window.changeSlide = function(parkIndex, direction) {
            var park = skateParks[parkIndex];
            var isComplex = (park.slides && park.slides.length > 0);
            var isSimple = (park.images && park.images.length > 1);
            if (!isComplex && !isSimple) return;

            var maxLen = isComplex ? park.slides.length : park.images.length;
            var currentIdx = currentSlideIndices[parkIndex];
            var nextIdx = currentIdx + direction;
            if (nextIdx < 0) nextIdx = maxLen - 1;
            if (nextIdx >= maxLen) nextIdx = 0;
            
            currentSlideIndices[parkIndex] = nextIdx; 

            var imgEl = document.getElementById(`slideImg_${parkIndex}`);
            if (imgEl) {
                var nextSrc = isComplex ? park.slides[nextIdx].img : park.images[nextIdx];
                imgEl.src = nextSrc;
            }

            if (isComplex) {
                var data = park.slides[nextIdx];
                var titleEl = document.getElementById(`slideTitle_${parkIndex}`);
                var descEl = document.getElementById(`slideDesc_${parkIndex}`);
                var detailEl = document.getElementById(`slideDetail_${parkIndex}`);

                if (titleEl) titleEl.innerHTML = `${data.title} <span class="diff-tag ${data.diffClass}">${data.diff}</span>`;
                if (descEl) descEl.innerHTML = `ğŸ“ ${data.desc}`;
                if (detailEl) detailEl.innerHTML = `ğŸ“ ${data.detail}`;
            }
        }

        window.openLumaModal = function(index) {
            var data = skateParks[index];
            if(!data.lumaSections) { alert("3D ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!"); return; }

            var modal = document.getElementById('lumaModal');
            var btnContainer = document.getElementById('sectionBtnContainer');
            var frame = document.getElementById('lumaFrame');
            
            btnContainer.innerHTML = '';
            data.lumaSections.forEach((sec, i) => {
                var btn = document.createElement('button');
                btn.className = 'sec-btn';
                if(i === 0) btn.classList.add('active'); 
                btn.innerText = sec.name;
                btn.onclick = function() {
                    loadLumaSafe(frame, sec.url);
                    document.querySelectorAll('.sec-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                };
                btnContainer.appendChild(btn);
            });
            loadLumaSafe(frame, data.lumaSections[0].url);
            modal.classList.add('show');
        }

        window.closeModal = function() {
            document.getElementById('lumaModal').classList.remove('show');
            document.getElementById('lumaFrame').src = '';
        }

        function loadLumaSafe(frame, originalUrl) {
            var embedUrl = originalUrl.replace("capture", "embed");
            var separator = embedUrl.includes("?") ? "&" : "?";
            frame.src = embedUrl + separator + "mode=sparkles&background=%23000000&autoLoad=true";
        }
    </script>
</body>
</html>